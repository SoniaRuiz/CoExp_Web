@model CoexpParams
@{
    ViewData["Title"] = "Gene Set Annotation";
}

@Html.HiddenFor(m => m.Category)
@Html.HiddenFor(m => m.Network)
@Html.HiddenFor(m => m.ModuleColor)
@Html.HiddenFor(m => m.Genes)

<div class="breadcrumb">
    @if (ViewContext.RouteData.Values["controller"].ToString() != "Home")
    {
        <span class="main-label-breadcrumbs">CoExp</span>@*@Html.ActionLink(ViewContext.RouteData.Values["controller"].ToString(), "Index", ViewContext.RouteData.Values["controller"].ToString())*@
        <span class="glyphicon glyphicon-chevron-right"></span>
        <span class="active">Gene Set Annotation</span>

    }
    @*@if (ViewContext.RouteData.Values["action"].ToString() != "Index")
        {
            @Html.ActionLink("Gene Set Annotation", ViewContext.RouteData.Values["action"].ToString(), ViewContext.RouteData.Values["controller"].ToString())
        }*@
</div>
<div class="row">
    <div class="col-sm-3 sidebar menu">
        <h4>Please, make your selection:</h4>
        <hr class="menu-hr" />
        <div id="step1">
            <label for="tree">Network:</label>
            <span class="glyphicon glyphicon-info-sign"
               data-toggle="tooltip"
               data-placement="right"
               data-html="true"
               title="<br/>NETWORK<hr/><p style='text-align: left;'>Select here your preferred co-expression network.<br/><br/>You can select one or more networks from the same or multiple categories.</p><br/>"
               style="vertical-align: middle;"></span>
            <br />
            <div id="tree"></div>
        </div>

        <div id="step2">
            <label for="genes">Genes:</label>
            <span class="glyphicon glyphicon-info-sign"
               data-toggle="tooltip"
               data-placement="right"
               data-html="true"
               title="<br/><p>GENES</p><hr/><p style='text-align: left;'>Type here a list with your genes of interest in a comma-separated or blank-space-separated fashion.<br/><br/>The gene list can contain from one single gene to a non-maximum stablished.<br/><br/>Please, be aware that the larger the list, the longer the request may take.</p><br/>"
               style="vertical-align: middle;"></span>
            <br />
            <textarea class="form-control" rows="7" id="genes" placeholder="Type your genes ..."></textarea>
        </div>

        <br>
        <hr class="menu-hr" />
        <div id="step3">
            <button id="send_button" class="btn btn-primary">Accept</button>
        </div>
    </div>



    <div id="step4" class="col-md-9">

        <div id="empty-initial-results">
            <p>Your results will appear here.</p>
        </div>

        <div id="genes_not_found" class="modal fade" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header text-center">
                        <button id="close_feedback" type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h3>Your Gene List</h3>
                        <hr />
                        <div class="text-left">
                            <h4></h4><hr />
                            <h4></h4>
                            <p>
                                The following genes have not been found within the networks selected.<br />
                                Would you like to continue with your query?
                            </p>
                        </div>
                    </div>
                    <div class="modal-body mx-3 pre-scrollable">
                        <table id="table_genes_not_found" class="table table-hover table-striped table-responsive">
                            <thead>
                                <tr>
                                    <td>Entered</td>
                                    <td>Status</td>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button onclick="javascript:API.prototype.genesNotFoundAction('continue');" class="btn btn-success">Continue</button>
                        <button onclick="javascript:API.prototype.genesNotFoundAction('cancel');" class="btn btn-dark">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        @*<div id="reportOnGenes_div" style="display:none;">
            <h3><u>Gene Annotation</u></h3>
            <br>
            <table id="reportOnGenes_table" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th></th>
                        <th>Gene</th>
                        <th>Category</th>
                        <th>Network</th>
                        <th>Gene Ensembl</th>
                        <th>p-value Fisher</th>
                        <th>Module</th>
                        <th>Module Membership</th>
                        <th>Module Size</th>
                        <th>Go Term</th>
                        <th>Cell Type</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th></th>
                        <th>Gene</th>
                        <th>Category</th>
                        <th>Network</th>
                        <th>Gene Ensembl</th>
                        <th>p-value Fisher</th>
                        <th>Module</th>
                        <th>Module Membership</th>
                        <th>Module Size</th>
                        <th>Go Term</th>
                        <th>Cell Type</th>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div id="summariseClustering_div">
            <h3><u>Summarise Clustering</u></h3>
            <br>
            <table id="summariseClustering_table" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th></th>
                        <th>network</th>
                        <th>category</th>
                        <th>module</th>
                        <th>overlap</th>
                        <th>gene</th>
                        <th>fisher</th>
                        <th>size</th>
                        <th>go_report</th>
                        <th>cell_type_pred</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th></th>
                        <th>network</th>
                        <th>category</th>
                        <th>module</th>
                        <th>overlap</th>
                        <th>gene</th>
                        <th>fisher</th>
                        <th>size</th>
                        <th>go_report</th>
                        <th>cell_type_pred</th>
                    </tr>
                </tfoot>
            </table>
        </div>*@
        
    <div id="globalReportOnGenes_div">

        <h2>Gene Annotation</h2>
        <p>
            The table below displays in which modules, from the selected co-expression networks, have clustered together the list of genes introduced.
            Each row contain each one of the typed genes that have been successfully found in any of the modules belonging to the networks selected.
            The columns, on the other hand, show information related to the gene and the module where it has been found, including different p-values supporting that membership.
            The raw data that supports the generation of this data table is available to be downloaded under the three buttons placed on its upper-left-side corner.<br />
            Press 'SUMMARISE CLUSTERING' button to group the results by module.
        </p>
        <br>
        <table id="globalReportOnGenes_table" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th></th>
                    <th>Gene</th>
                    <th>Category</th>
                    <th>Network</th>
                    <th>Gene Ensembl</th>
                    <th>
                        p-value Fisher
                        <span class="glyphicon glyphicon-info-sign"
                              data-toggle="tooltip"
                              data-placement="right"
                              data-html="true"
                              title="<p style='text-align: left;'><u>p-value Fisher</u><br/><br/>p-value that represents how significant is the overlap between your gene list and the genes that lie within the current module.<br/><br/>This p-value has been obtained by applying the Fisher's exact test over the overlap of genes mentioned before.</p>"
                              style="vertical-align: middle;"></span>
                    </th>
                    <th>
                        p-value FDR
                        <span class="glyphicon glyphicon-info-sign"
                              data-toggle="tooltip"
                              data-placement="right"
                              data-html="true"
                              title="<p style='text-align: left;'><u>p-value FDR</u><br/><br/>p-value that represents how significant is the overlap between your gene list and the genes that lie within the current module.<br/><br/>
                               This p-value has been obtained by the Fisher's Exact test adjusted by a 'False Discovery Rate' function for multiple testing."
                              style="vertical-align: middle;"></span>
                    </th>
                    <th>
                        p-value Bonferroni
                        <span class="glyphicon glyphicon-info-sign"
                              data-toggle="tooltip"
                              data-placement="right"
                              data-html="true"
                              title="<p style='text-align: left;'><u>p-value Bonferroni</u><br/><br/>p-value that represents how significant is the overlap between your gene list and the genes that lie within the current module.<br/><br/>
                               This p-value has been corrected by the Bonferroni correction factor. This method applies its correction based on the number of modules per each network that contains any gene from your input set."
                              style="vertical-align: middle;"></span>
                    </th>
                    <th>Module</th>
                    <th>
                        Module Membership (mm)
                        <span class="glyphicon glyphicon-info-sign"
                              data-toggle="tooltip"
                              data-placement="right"
                              data-html="true"
                              title="<p style='text-align: left;'><u>Module Membership (mm)</u><br /><br />mm represents a degree of membership of a gene to a module. <br /><br />When the mm is close to 0, the likelihood of that gene belonging to the module is very low. When the mm is close to 1 or −1, the gene the likelihood of that gene belonging to the module is high.<br /><br />" 
                              style="vertical-align: middle;"></span>
                    </th>
                    <th>
                        Module Size
                        <span class="glyphicon glyphicon-info-sign"
                              data-toggle="tooltip"
                              data-placement="right"
                              data-html="true"
                              title="<p style='text-align: left;'><u>Module Size</u><br /><br />Total number of genes in the current module.<br /><br />" 
                              style="vertical-align: middle;"></span>

                    </th>
                    <th>GO Report</th>
                    <th>Cell Type</th>
                </tr>
            </thead>
        </table>
    </div>
    <div id="globalSummariseReportOnGenes_div">

        <h2>Summarise Clustering</h2>
        <p>
            The table below displays the results grouped by module, showing the overlap of the introduced genes that have clustered together in the same module.<br />
            Press 'EXPAND RESULTS' button to come back to the original data table view.
        </p>
        <br>
        <table id="globalSummariseReportOnGenes_table" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th></th>
                    <th>Network</th>
                    <th>Category</th>
                    <th>Module</th>
                    <th>
                        Overlap
                        <span class="glyphicon glyphicon-info-sign"
                              data-toggle="tooltip"
                              data-placement="right"
                              data-html="true"
                              title="<p style='text-align: left;'><u>Overlap</u><br/><br/>Total number of genes from your gene list that have been found in the current module.</p>"
                              style="vertical-align: middle;"></span>
                    </th>
                    <th>Gene</th>
                    <th>
                        p-value Fisher
                        <span class="glyphicon glyphicon-info-sign"
                              data-toggle="tooltip"
                              data-placement="right"
                              data-html="true"
                              title="<p style='text-align: left;'><u>p-value Fisher</u><br/><br/>p-value that represents how significant is the overlap between your gene list and the genes that lie within the current module.<br/><br/>This p-value has been obtained by applying the Fisher\'s exact test over the overlap mentioned before.</p>"
                              style="vertical-align: middle;"></span>
                    </th>
                    <th>
                        p-value FDR
                        <span class="glyphicon glyphicon-info-sign"
                              data-toggle="tooltip"
                              data-placement="right"
                              data-html="true"
                              title="<p style='text-align: left;'><u>p-value FDR</u><br/><br/>p-value that represents how significant is the overlap between your gene list and the genes that lie within the current module.<br/><br/>
                               This p-value has been obtained by the Fisher's Exact test adjusted by a 'False Discovery Rate' function for multiple testing."
                              style="vertical-align: middle;"></span>
                    </th>
                    <th>
                        p-value Bonferroni
                        <span class="glyphicon glyphicon-info-sign"
                              data-toggle="tooltip"
                              data-placement="right"
                              data-html="true"
                              title="<p style='text-align: left;'><u>p-value Bonferroni</u><br/><br/>p-value that represents how significant is the overlap between your gene list and the genes that lie within the current module.<br/><br/>
                               This p-value has been corrected by the Bonferroni correction factor. This method applies its correction based on the number of modules per each network that contains any gene from your input set."
                              style="vertical-align: middle;"></span>
                    </th>
                    <th>
                        Module Size
                        <span class="glyphicon glyphicon-info-sign"
                              data-toggle="tooltip"
                              data-placement="right"
                              data-html="true"
                              title="<p style='text-align: left;'><u>Module Size</u><br /><br />Total number of genes in the current module.<br /><br />"
                              style="vertical-align: middle;"></span>
                    </th>
                    <th>GO Report</th>
                    <th>Cell Type</th>
                </tr>
            </thead>
        </table>
    </div>
        <br>
        <div id="error" class="alert alert-danger">
            <h4></h4>
        </div>
    </div>
    <div class="loading_layer"><!-- loading layer --></div>

</div>
<br>
@section HeadStyles{
    <link type="text/css" rel="stylesheet" href="~/css/dataTables.bootstrap4.min.css">
    <link type="text/css" rel="stylesheet" href="~/css/buttons.dataTables.min.css">
    <link type="text/css" rel="stylesheet" href="~/css/jquery.dataTables.min.css" />
    <link type="text/css" rel="stylesheet" href="~/css/fixedColumns.dataTables.min.css" />
    <link type="text/css" rel="stylesheet" href="~/css/custom.dataTables.css" />
    <link type="text/css" rel="stylesheet" href="~/css/simTree.css">

}
@section Scripts{
    <script type="text/javascript" src="~/js/underscore-min.js"></script>

    <!--Multiselect scripts -->
    <script type="text/javascript" src="~/js/simTree.min.js"></script>

    <!-- DataTable scripts-->
    <script type="text/javascript" src="~/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="~/js/dataTables.bootstrap4.min.js"></script>

    <environment include="Development,Docker,Private">
        <script type="text/javascript" src="~/js/api.js"></script>
    </environment>
    <environment include="Production">
        <script type="text/javascript" src="~/js/api.min.js"></script>
    </environment>

    <script type="text/javascript" src="~/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="~/js/buttons.flash.min.js"></script>
    <script type="text/javascript" src="~/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="~/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="~/js/jszip.min.js"></script>
    @*<script type="text/javascript" src="~/js/pdfmake.min.js"></script>*@
    <script type="text/javascript" src="~/lib/pdfmake/pdfmake.min.js"></script>
    <script type="text/javascript" src="~/lib/pdfmake/vfs_fonts.min.js"></script>

    <script>
        $(document).ready(function () {
            $('[data-toggle="tooltip"]').tooltip()
            // Turn active current menu's option
            $(".nav-item").find(".active").removeClass("active");
            $("#tab_gene_set_annotation").addClass("active");

            API.prototype.menuInit(3);
            $.fn.dataTable.ext.errMode = 'none';
            $("#empty-initial-results").css("visibility", "visible");

        });

        function startIntro() {
            var intro = introJs();
            intro.setOptions({
                steps: [
                    {
                        element: '#step1',
                        intro: "<p><b>Network</b></p><p>Select here your preferred co-expression network.<br/><br/>You can select one or more networks from the same or multiple categories.</p>",
                        position: 'right'
                    },
                    {
                        element: '#step2',
                        intro: "<b>Genes</b><br/><br/>Type here a list with your genes of interest in a comma-separated or blank-space-separated fashion.<br/><br/>The gene list can contain from one single gene to no maximum stablished.<br/><br/>Please, be aware that the larger the list, the longer the request may take.",
                        position: 'right'
                    },
                    {
                        element: '#step3',
                        intro: "<b>Accept</b><br/><br/>Once you are ready, press 'Accept' to send your query.",
                        position: 'right'
                    },
                    {
                        element: '#step4',
                        intro: "<b>Results</b><br/><br/>This is the results area. Your results will appear here.",
                        position: 'right'
                    }
                ]
            });



            var doneTourAnnotated = sessionStorage.getItem('EventTourAnnotated') === 'Completed';
            if (doneTourAnnotated) {
                return;
            }
            else {
                intro.start();

                intro.oncomplete(function () {
                    sessionStorage.setItem('EventTourAnnotated', 'Completed');
                });

                intro.onexit(function () {
                    sessionStorage.setItem('EventTourAnnotated', 'Completed');
                });
            }

        }
    </script>
}
